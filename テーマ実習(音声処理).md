
# テーマ実習(音声処理)
## 6/3音声処理のための環境構築
- VSCodeのインストール
- pyenvのインストール(pythonのバージョンを切り替えるため)
```
export PYENV_ROOT="$HOME/.pyenv"
export PATH="$PYENV_ROOT/bin:$PATH"
if command -v pyenv 1>/dev/null 2>&1; then
  eval "$(pyenv init --path)"
fi
```
-　その他パッケージのインストール(pipのバージョンがアップデートされていない場合はエラーが出るので、先にpipのアップデートを行う)
```
pip install --upgrade pip
```
```
pip install pyworld
pip install librosa
pip install pandas
pip install matplotlib
pip install tqdm
pip install jupyterlab
```
## 6/9pythonで行う音声処理の説明

-コードの意味

>#Vocoder Functions
>import pyworld as pw
>_f0, t = pw.dio(x, fs)    # raw pitch extractor
>f0 = pw.stonemask(x, _f0, t, fs)  # pitch refinement
>sp = pw.cheaptrick(x, f0, t, fs)  # extract smoothed spectrogram
>ap = pw.d4c(x, f0, t, fs)         # extract aperiodicity
>
>y = pw.synthesize(f0, sp, ap, fs) # synthesize an utterance using the parameters
>Utility
># Convert speech into features (using default arguments)
>f0, sp, ap = pw.wav2world(x, fs)

tは時間、fsは周波数、xはwavファイルなどを読み込んだlow wave
```
f0, t = pw.dio(x, fs)
```
F0(声帯にあたる)を整える。このF0を変換し、音声合成することで声がどのように変化するのかを調べる。
```
f0 = pw.stonemask(x, _f0, t, fs)
```
スペクトル包絡(声道にあたる)を取り出す
```
sp = pw.cheaptrick(x, f0, t, fs)
```
非周期性指標(「く」や「つ」」などの無声音にあたる)を取り出す
```
ap = pw.d4c(x, f0, t, fs)
```
音声合成を行う
```
y = pw.synthesize(f0, sp, ap, fs)
```

## 6/24pythonで10000個のデータからf0の値を抽出する
#### f0の値を抽出するためのコードを書く

使用するパッケージをインポートする。(特にtqdmは実行時間の経過を表示することができる)
```
import pyworld as pw
import os
import numpy as np
import pandas as pd
import librosa
from tqdm import tqdm
```
10000個のデータを一度に処理するために、データを使いやすいように抜き出す。
まず100人のファイルを抜き出す
```
dir_path = "パス名"
speaker = []
for i in os.listdir(dir_path):
    if os.path.isdir(dir_path + i):
        speaker.append(i + "/")
```
次に100人のファイルのwavファイルを抜き出す。
```
wav_path = os.listdir(dir_path + speaker[0] + "parallel100/wav24kHz16bit/")
```
f0を抽出したデータを保存するためのディレクトリを作成する。
```
for i in speaker:
    os.makedirs("/Users/katouryuusei/Downloads/専門ゼミ/第9回/voice_conversion/feature/f0/" + i,exist_ok = True)
```
データから　f0値を抽出して作成したディレクトリに書き出す。
ファイルに欠損があるため「except」を使いエラーを回避する。
```
fs = 24000
for i in tqdm(speaker):
    for j in wav_path:
        try:
            x, fs = librosa.load(dir_path + i + "parallel100/wav24kHz16bit/" + j,sr = fs,dtype = np.float64)
            _f0, t = pw.dio(x, fs)
            f0 = pw.stonemask(x, _f0, t, fs)
            pd.to_pickle(f0, os.getcwd() + "/voice_conversion/feature/f0/" + i + j[:-4] + ".pkl")
        except FileNotFoundError:
            continue
```
